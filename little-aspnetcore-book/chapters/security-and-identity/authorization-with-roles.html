<!DOCTYPE HTML>
<html lang="es" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Autorización con roles · El pequeño libro de ASP.NET Core</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Nate Barbettini">
        <meta name="identifier" content="978-1-387-75615-5" scheme="ISBN">
    <link rel="stylesheet" href="/assets/gitbook/style.css">
                <link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.css">
                <link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-anchors/plugin.css">
                <link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-forkmegithub/plugin.css">
                <link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-highlight/website.css">
                <link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-search/search.css">
                <link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-fontsettings/website.css">
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="/assets/gitbook/images/favicon.ico" type="image/x-icon">
    <link rel="next" href="more-resources.html" />
    <link rel="prev" href="using-identity-in-the-application.html" />
    <meta property="fb:pages" content="1282476685124585" />
    <meta property="og:type" content="website" />
    <meta property="fb:app_id" content="561661137677920" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-130293099-1"></script>
    <script>
        window['ga-disable-UA-130293099-1'] = window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1";
  window.dataLayer = window.dataLayer || [];
        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());
        gtag('config', 'UA-130293099-1');
    </script>
    </head>
    <body>
<div class="book">
    <div class="book-summary">
<div id="book-search-input" role="search">
    <input type="text" placeholder="Escribe para buscar" />
</div>
                <nav role="navigation">
<ul class="summary">
        <li class="chapter " data-level="1.1" data-path="../../">
                <a href="../../">
                    Introducción
                </a>
        </li>
        <li class="chapter " data-level="1.2" data-path="../your-first-application/">
                <a href="../your-first-application/">
                    Tú primera aplicación
                </a>
            <ul class="articles">
        <li class="chapter " data-level="1.2.1" data-path="../your-first-application/get-the-sdk.html">
                <a href="../your-first-application/get-the-sdk.html">
                    Consigue el SDK
                </a>
        </li>
        <li class="chapter " data-level="1.2.2" data-path="../your-first-application/hello-world-in-csharp.html">
                <a href="../your-first-application/hello-world-in-csharp.html">
                    Hola Mundo en C#
                </a>
        </li>
        <li class="chapter " data-level="1.2.3" data-path="../your-first-application/create-aspnetcore-project.html">
                <a href="../your-first-application/create-aspnetcore-project.html">
                    Crear un proyecto de ASP.NET Core
                </a>
        </li>
            </ul>
        </li>
        <li class="chapter " data-level="1.3" data-path="../mvc-basics/">
                <a href="../mvc-basics/">
                    Fundamentos de MVC
                </a>
            <ul class="articles">
        <li class="chapter " data-level="1.3.1" data-path="../mvc-basics/create-controller.html">
                <a href="../mvc-basics/create-controller.html">
                    Crear un controlador
                </a>
        </li>
        <li class="chapter " data-level="1.3.2" data-path="../mvc-basics/create-models.html">
                <a href="../mvc-basics/create-models.html">
                    Crear modelos
                </a>
        </li>
        <li class="chapter " data-level="1.3.3" data-path="../mvc-basics/create-view.html">
                <a href="../mvc-basics/create-view.html">
                    Crear una vista
                </a>
        </li>
        <li class="chapter " data-level="1.3.4" data-path="../mvc-basics/add-service-class.html">
                <a href="../mvc-basics/add-service-class.html">
                    Agregar una clase de servicio
                </a>
        </li>
        <li class="chapter " data-level="1.3.5" data-path="../mvc-basics/use-dependency-injection.html">
                <a href="../mvc-basics/use-dependency-injection.html">
                    Usar inyección de dependencias
                </a>
        </li>
        <li class="chapter " data-level="1.3.6" data-path="../mvc-basics/finish-controller.html">
                <a href="../mvc-basics/finish-controller.html">
                    Terminando el controlador
                </a>
        </li>
        <li class="chapter " data-level="1.3.7" data-path="../mvc-basics/update-the-layout.html">
                <a href="../mvc-basics/update-the-layout.html">
                    Actualizar la plantilla
                </a>
        </li>
            </ul>
        </li>
        <li class="chapter " data-level="1.4" data-path="../add-external-packages/">
                <a href="../add-external-packages/">
                    Agregando paquetes externos
                </a>
        </li>
        <li class="chapter " data-level="1.5" data-path="../use-a-database/">
                <a href="../use-a-database/">
                    Usando una base de datos
                </a>
            <ul class="articles">
        <li class="chapter " data-level="1.5.1" data-path="../use-a-database/connect-to-a-database.html">
                <a href="../use-a-database/connect-to-a-database.html">
                    Conectarse a una base de datos
                </a>
        </li>
        <li class="chapter " data-level="1.5.2" data-path="../use-a-database/update-context.html">
                <a href="../use-a-database/update-context.html">
                    Actualizando el contexto
                </a>
        </li>
        <li class="chapter " data-level="1.5.3" data-path="../use-a-database/create-migration.html">
                <a href="../use-a-database/create-migration.html">
                    Crear una migración
                </a>
        </li>
        <li class="chapter " data-level="1.5.4" data-path="../use-a-database/create-service-class.html">
                <a href="../use-a-database/create-service-class.html">
                    Crear una nueva clase de servicio
                </a>
        </li>
            </ul>
        </li>
        <li class="chapter " data-level="1.6" data-path="../add-more-features/">
                <a href="../add-more-features/">
                    Agregando más características
                </a>
            <ul class="articles">
        <li class="chapter " data-level="1.6.1" data-path="../add-more-features/add-todo-items.html">
                <a href="../add-more-features/add-todo-items.html">
                    Agregar nuevas tareas
                </a>
        </li>
        <li class="chapter " data-level="1.6.2" data-path="../add-more-features/complete-with-checkbox.html">
                <a href="../add-more-features/complete-with-checkbox.html">
                    Completar las tareas con una casilla de verificación
                </a>
        </li>
            </ul>
        </li>
        <li class="chapter " data-level="1.7" data-path="./">
                <a href="./">
                    Seguridad e Identidad
                </a>
            <ul class="articles">
        <li class="chapter " data-level="1.7.1" data-path="require-authentication.html">
                <a href="require-authentication.html">
                    Requerir autenticación
                </a>
        </li>
        <li class="chapter " data-level="1.7.2" data-path="using-identity-in-the-application.html">
                <a href="using-identity-in-the-application.html">
                    Usando identidad en la aplicación
                </a>
        </li>
        <li class="chapter active" data-level="1.7.3" data-path="authorization-with-roles.html">
                <a href="authorization-with-roles.html">
                    Autorización con roles
                </a>
        </li>
        <li class="chapter " data-level="1.7.4" data-path="more-resources.html">
                <a href="more-resources.html">
                    Más recursos
                </a>
        </li>
            </ul>
        </li>
        <li class="chapter " data-level="1.8" data-path="../automated-testing/">
                <a href="../automated-testing/">
                    Pruebas automáticas
                </a>
            <ul class="articles">
        <li class="chapter " data-level="1.8.1" data-path="../automated-testing/unit-testing.html">
                <a href="../automated-testing/unit-testing.html">
                    Pruebas unitarias
                </a>
        </li>
        <li class="chapter " data-level="1.8.2" data-path="../automated-testing/integration-testing.html">
                <a href="../automated-testing/integration-testing.html">
                    Pruebas de integración
                </a>
        </li>
            </ul>
        </li>
        <li class="chapter " data-level="1.9" data-path="../deploy-the-application/">
                <a href="../deploy-the-application/">
                    Desplegando la aplicación
                </a>
            <ul class="articles">
        <li class="chapter " data-level="1.9.1" data-path="../deploy-the-application/deploy-to-azure.html">
                <a href="../deploy-the-application/deploy-to-azure.html">
                    Desplegando en Azure
                </a>
        </li>
        <li class="chapter " data-level="1.9.2" data-path="../deploy-the-application/deploy-with-docker.html">
                <a href="../deploy-the-application/deploy-with-docker.html">
                    Desplegando con Docker
                </a>
        </li>
            </ul>
        </li>
        <li class="chapter " data-level="1.10" data-path="../conclusion/">
                <a href="../conclusion/">
                    Conclusión
                </a>
        </li>
    <li class="divider"></li>
    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Publicado con GitBook
        </a>
    </li>
</ul>
                </nav>
    </div>
    <div class="book-body">
            <div class="body-inner">
<div class="book-header" role="navigation">
    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Autorización con roles</a>
    </h1>
</div>
                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
<div id="book-search-results">
    <div class="search-noresults">
                                <section class="normal markdown-section">
                                <h2 id="autorizaci&#xF3;n-con-roles"><a name="autorizaci&#xF3;n-con-roles" class="plugin-anchor" href="#autorizaci&#xF3;n-con-roles"><i class="fa fa-link" aria-hidden="true"></i></a>Autorizaci&#xF3;n con roles</h2>
<p>Los roles son un enfoque com&#xFA;n para el manejo de permisos y autorizaciones en una aplicaci&#xF3;n web. Por ejemplo, es com&#xFA;n crear una rol de administrador que otorgue a los usuarios administradores m&#xE1;s permisos o poder que los usuarios normales.</p>
<p>En este proyecto, agregar&#xE1; una p&#xE1;gina para Administrar usuarios que solo los administradores pueden ver. Si los usuarios normales intentan acceder a &#xE9;l, ver&#xE1;n un error.</p>
<h3 id="agregar-una-p&#xE1;gina-administrar-usuarios"><a name="agregar-una-p&#xE1;gina-administrar-usuarios" class="plugin-anchor" href="#agregar-una-p&#xE1;gina-administrar-usuarios"><i class="fa fa-link" aria-hidden="true"></i></a>Agregar una p&#xE1;gina Administrar usuarios</h3>
<p>Primero, crea un nuevo controlador:</p>
<p><strong>Controllers/ManageUsersController.cs</strong></p>
<pre><code class="lang-csharp"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Threading.Tasks;
<span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc;
<span class="hljs-keyword">using</span> Microsoft.AspNetCore.Authorization;
<span class="hljs-keyword">using</span> Microsoft.AspNetCore.Identity;
<span class="hljs-keyword">using</span> AspNetCoreTodo.Models;
<span class="hljs-keyword">using</span> Microsoft.EntityFrameworkCore;
<span class="hljs-keyword">namespace</span> <span class="hljs-title">AspNetCoreTodo.Controllers</span>
{
    [Authorize(Roles = <span class="hljs-string">&quot;Administrator&quot;</span>)]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ManageUsersController</span> : <span class="hljs-title">Controller</span>
    {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> UserManager&lt;ApplicationUser&gt;
            _userManager;
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ManageUsersController</span>(<span class="hljs-params">
            UserManager&lt;ApplicationUser&gt; userManager</span>)
        </span>{
            _userManager = userManager;
        }
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">Index</span>(<span class="hljs-params"></span>)
        </span>{
            <span class="hljs-keyword">var</span> admins = (<span class="hljs-keyword">await</span> _userManager
                .GetUsersInRoleAsync(<span class="hljs-string">&quot;Administrator&quot;</span>))
                .ToArray();
            <span class="hljs-keyword">var</span> everyone = <span class="hljs-keyword">await</span> _userManager.Users
                .ToArrayAsync();
            <span class="hljs-keyword">var</span> model = <span class="hljs-keyword">new</span> ManageUsersViewModel
            {
                Administrators = admins,
                Everyone = everyone
            };
            <span class="hljs-keyword">return</span> View(model);
        }
    }
}
</code></pre>
<p>La configuraci&#xF3;n de la propiedad <code>Roles</code> en el atributo <code>[Authorize]</code>garantizar&#xE1; que el usuario tenga que iniciar sesi&#xF3;n <strong>y</strong> se le asigne el rol de Administrador para poder ver la p&#xE1;gina.</p>
<p>A continuaci&#xF3;n, crea un modelo para la vista:</p>
<p><strong>Models/ManageUsersViewModel.cs</strong></p>
<pre><code class="lang-csharp"><span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">namespace</span> <span class="hljs-title">AspNetCoreTodo.Models</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ManageUsersViewModel</span>
    {
        <span class="hljs-keyword">public</span> ApplicationUser[] Administrators { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> ApplicationUser[] Everyone { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>;}
    }
}
</code></pre>
<p>Finalmente, cree una carpeta <code>Views/ManageUsers</code> y una vista para la acci&#xF3;n <code>Index</code>:</p>
<p><strong>Views/ManageUsers/Index.cshtml</strong></p>
<pre><code class="lang-html">@model ManageUsersViewModel
@{
    ViewData[&quot;Title&quot;] = &quot;Manage users&quot;;
}
<span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>@ViewData[&quot;Title&quot;]<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Administrators<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;table&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">thead</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>Id<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>Email<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">thead</span>&gt;</span>
    @foreach (var user in Model.Administrators)
    {
        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>@user.Id<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>@user.Email<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
    }
<span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Everyone<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;table&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">thead</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>Id<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>Email<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">thead</span>&gt;</span>
    @foreach (var user in Model.Everyone)
    {
        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>@user.Id<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>@user.Email<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
    }
<span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span>
</code></pre>
<p>Inicie la aplicaci&#xF3;n e intente acceder a la ruta <code>/ManageUsers</code> mientras est&#xE9; conectado como un usuario normal. Ver&#xE1;s esta p&#xE1;gina de acceso denegado:</p>
<p><img src="access-denied.png" alt="Error de acceso denegado"></p>
<p>Eso es porque a los usuarios no se les asigna autom&#xE1;ticamente el rol de Administrador.</p>
<h3 id="crear-una-cuenta-de-administrador-de-prueba"><a name="crear-una-cuenta-de-administrador-de-prueba" class="plugin-anchor" href="#crear-una-cuenta-de-administrador-de-prueba"><i class="fa fa-link" aria-hidden="true"></i></a>Crear una cuenta de administrador de prueba</h3>
<p>Por razones obvias de seguridad, no es posible que nadie registre una nueva cuenta de administrador. De hecho, el rol de administrador ni siquiera existe en la base de datos todav&#xED;a.</p>
<p>Puede agregar el rol de administrador m&#xE1;s una cuenta de administrador de prueba a la base de datos la primera vez que se inicie la aplicaci&#xF3;n. Agregar datos por primera vez a la base de datos se llama inicializar o <strong>sembrar</strong> la base de datos.</p>
<p>Crea una nueva clase en la ra&#xED;z del proyecto llamada <code>SeedData</code>:</p>
<p><strong>SeedData.cs</strong></p>
<pre><code class="lang-csharp"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Threading.Tasks;
<span class="hljs-keyword">using</span> AspNetCoreTodo.Models;
<span class="hljs-keyword">using</span> Microsoft.AspNetCore.Identity;
<span class="hljs-keyword">using</span> Microsoft.EntityFrameworkCore;
<span class="hljs-keyword">using</span> Microsoft.Extensions.DependencyInjection;
<span class="hljs-keyword">namespace</span> <span class="hljs-title">AspNetCoreTodo</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SeedData</span>
    {
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">InitializeAsync</span>(<span class="hljs-params">
            IServiceProvider services</span>)
        </span>{
            <span class="hljs-keyword">var</span> roleManager = services
                .GetRequiredService&lt;RoleManager&lt;IdentityRole&gt;&gt;();
            <span class="hljs-keyword">await</span> EnsureRolesAsync(roleManager);
            <span class="hljs-keyword">var</span> userManager = services
                .GetRequiredService&lt;UserManager&lt;ApplicationUser&gt;&gt;();
            <span class="hljs-keyword">await</span> EnsureTestAdminAsync(userManager);
        }
    }
}
</code></pre>
<p>El m&#xE9;todo <code>InitializeAsync()</code> utiliza un <code>IServiceProvider</code> (la colecci&#xF3;n de servicios que se configura en el m&#xE9;todo <code>Startup.ConfigureServices()</code>) para obtener el <code>RoleManager</code> y el <code>UserManager</code> de ASP.NET Core Identity.</p>
<p>Agregue dos m&#xE9;todos m&#xE1;s debajo del m&#xE9;todo <code>InitializeAsync()</code>. Primero, el m&#xE9;todo <code>VerifyRolesAsync()</code>:</p>
<pre><code class="lang-csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">EnsureRolesAsync</span>(<span class="hljs-params">
    RoleManager&lt;IdentityRole&gt; roleManager</span>)
</span>{
    <span class="hljs-keyword">var</span> alreadyExists = <span class="hljs-keyword">await</span> roleManager
        .RoleExistsAsync(Constants.AdministratorRole);
    <span class="hljs-keyword">if</span> (alreadyExists) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">await</span> roleManager.CreateAsync(
        <span class="hljs-keyword">new</span> IdentityRole(Constants.AdministratorRole));
}
</code></pre>
<p>Este m&#xE9;todo verifica si existe un rol de <code>Administrador</code> en la base de datos. Si no, crea uno. En lugar de escribir repetidamente la cadena <code>&quot;Administrador&quot;</code>, cree una peque&#xF1;a clase llamada <code>Constants</code> para mantener el valor:</p>
<p><strong>Constants.cs</strong></p>
<pre><code class="lang-csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">AspNetCoreTodo</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Constants</span>
    {
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">string</span> AdministratorRole = <span class="hljs-string">&quot;Administrator&quot;</span>;
    }
}
</code></pre>
<blockquote>
<p>Si lo desea, puede actualizar el <code>ManageUsersController</code> para usar este valor constante tambi&#xE9;n.</p>
</blockquote>
<p>A continuaci&#xF3;n, escriba el m&#xE9;todo <code>EnsureTestAdminAsync()</code>:</p>
<p><strong>SeedData.cs</strong></p>
<pre><code class="lang-csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">EnsureTestAdminAsync</span>(<span class="hljs-params">
    UserManager&lt;ApplicationUser&gt; userManager</span>)
</span>{
    <span class="hljs-keyword">var</span> testAdmin = <span class="hljs-keyword">await</span> userManager.Users
        .Where(x =&gt; x.UserName == <span class="hljs-string">&quot;admin@todo.local&quot;</span>)
        .SingleOrDefaultAsync();
    <span class="hljs-keyword">if</span> (testAdmin != <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span>;
    testAdmin = <span class="hljs-keyword">new</span> ApplicationUser
    {
        UserName = <span class="hljs-string">&quot;admin@todo.local&quot;</span>,
        Email = <span class="hljs-string">&quot;admin@todo.local&quot;</span>
    };
    <span class="hljs-keyword">await</span> userManager.CreateAsync(
        testAdmin, <span class="hljs-string">&quot;NotSecure123!!&quot;</span>);
    <span class="hljs-keyword">await</span> userManager.AddToRoleAsync(
        testAdmin, Constants.AdministratorRole);
}
</code></pre>
<p>Si no hay un usuario con el nombre de usuario <code>admin@todo.local</code> en la base de datos, este m&#xE9;todo crear&#xE1; uno y le asignar&#xE1; una contrase&#xF1;a temporal. Despu&#xE9;s de iniciar sesi&#xF3;n por primera vez, &#xA1;debe cambiar la contrase&#xF1;a de la cuenta a algo seguro!</p>
<p>A continuaci&#xF3;n, debe indicar a su aplicaci&#xF3;n que ejecute esta l&#xF3;gica cuando se inicie. Modifique <code>Program.cs</code> y actualice <code>Main()</code>para llamar a un nuevo m&#xE9;todo, <code>InitializeDatabase()</code>:</p>
<p><strong>Program.cs</strong></p>
<pre><code class="lang-csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[] args</span>)
</span>{
    <span class="hljs-keyword">var</span> host = BuildWebHost(args);
    InitializeDatabase(host);
    host.Run();
}
</code></pre>
<p>Luego, agregue el nuevo m&#xE9;todo a la clase debajo de <code>Main()</code>:</p>
<pre><code class="lang-csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">InitializeDatabase</span>(<span class="hljs-params">IWebHost host</span>)
</span>{
    <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> scope = host.Services.CreateScope())
    {
        <span class="hljs-keyword">var</span> services = scope.ServiceProvider;
        <span class="hljs-keyword">try</span>
        {
            SeedData.InitializeAsync(services).Wait();
        }
        <span class="hljs-keyword">catch</span> (Exception ex)
        {
            <span class="hljs-keyword">var</span> logger = services
                .GetRequiredService&lt;ILogger&lt;Program&gt;&gt;();
            logger.LogError(ex, <span class="hljs-string">&quot;Error occurred seeding the DB.&quot;</span>);
        }
    }
}
</code></pre>
<p>Agregue esta declaraci&#xF3;n <code>using</code> al principio del archivo:</p>
<pre><code class="lang-csharp"><span class="hljs-keyword">using</span> Microsoft.Extensions.DependencyInjection;
</code></pre>
<p>Este m&#xE9;todo obtiene la colecci&#xF3;n de servicios que necesita <code>SeedData.InitializeAsync()</code> y luego ejecuta el m&#xE9;todo para inicializar la base de datos. Si algo sale mal, se registra un error.</p>
<blockquote>
<p>Como <code>InitializeAsync()</code> devuelve un <code>Task</code>, el m&#xE9;todo <code>Wait()</code>debe usarse para asegurarse de que finaliza antes de que la aplicaci&#xF3;n se inicie. Normalmente utilizar&#xED;as &quot;esperar&quot; para esto, pero por razones t&#xE9;cnicas no puedes usar &quot;esperar&quot; en la clase &quot;Programa&quot;. Esta es una rara excepci&#xF3;n. &#xA1;Debes usar <code>await</code> en cualquier otro lugar!</p>
</blockquote>
<p>Cuando inicie la aplicaci&#xF3;n a continuaci&#xF3;n, la cuenta <code>admin@todo.local</code> se crear&#xE1; y se le asignar&#xE1; el rol de Administrador. Intente iniciar sesi&#xF3;n con esta cuenta y navegue a <code>http://localhost:5000/ManageUsers</code>. Ver&#xE1;s una lista de todos los usuarios registrados para la aplicaci&#xF3;n.</p>
<blockquote>
<p>Como desaf&#xED;o adicional, intente agregar m&#xE1;s funciones de administraci&#xF3;n a esta p&#xE1;gina. Por ejemplo, podr&#xED;a agregar un bot&#xF3;n que le d&#xE9; a un administrador la posibilidad de eliminar una cuenta de usuario.</p>
</blockquote>
<h3 id="verificar-la-autorizaci&#xF3;n-en-una-vista"><a name="verificar-la-autorizaci&#xF3;n-en-una-vista" class="plugin-anchor" href="#verificar-la-autorizaci&#xF3;n-en-una-vista"><i class="fa fa-link" aria-hidden="true"></i></a>Verificar la autorizaci&#xF3;n en una vista</h3>
<p>El atributo <code>[Authorize]</code> facilita la verificaci&#xF3;n de autorizaci&#xF3;n en un controlador o m&#xE9;todo de acci&#xF3;n, pero &#xBF;qu&#xE9; sucede si necesita verificar la autorizaci&#xF3;n en una vista? Por ejemplo, ser&#xED;a bueno mostrar un enlace &quot;Administrar usuarios&quot; en la barra de navegaci&#xF3;n si el usuario que ha iniciado sesi&#xF3;n es un administrador.</p>
<p>Puede inyectar el <code>UserManager</code> directamente en una vista para realizar estos tipos de comprobaciones de autorizaci&#xF3;n. Para mantener sus vistas limpias y organizadas, cree una nueva vista parcial que agregar&#xE1; un elemento a la barra de navegaci&#xF3;n en el dise&#xF1;o:</p>
<p><strong>Views/Shared/_AdminActionsPartial.cshtml</strong></p>
<pre><code class="lang-html">@using Microsoft.AspNetCore.Identity
@using AspNetCoreTodo.Models
@inject SignInManager<span class="hljs-tag">&lt;<span class="hljs-name">ApplicationUser</span>&gt;</span> signInManager
@inject UserManager<span class="hljs-tag">&lt;<span class="hljs-name">ApplicationUser</span>&gt;</span> userManager
@if (signInManager.IsSignedIn(User))
{
    var currentUser = await userManager.GetUserAsync(User);
    var isAdmin = currentUser != null
        &amp;&amp; await userManager.IsInRoleAsync(
            currentUser,
            Constants.AdministratorRole);
    if (isAdmin)
    {
        <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;nav navbar-nav navbar-right&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">asp-controller</span>=<span class="hljs-string">&quot;ManageUsers&quot;</span> 
                   <span class="hljs-attr">asp-action</span>=<span class="hljs-string">&quot;Index&quot;</span>&gt;</span>
                   Manage Users
                <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    }
}
</code></pre>
<blockquote>
<p>Es una convenci&#xF3;n nombrar vistas parciales compartidas que comienzan con un gui&#xF3;n bajo <code>_</code>, pero no es obligatorio.</p>
</blockquote>
<p>Esta vista parcial primero utiliza el <code>SignInManager</code> para determinar r&#xE1;pidamente si el usuario est&#xE1; conectado. Si no lo est&#xE1;, el resto del c&#xF3;digo de vista se puede omitir. Si hay <strong>hay</strong> un usuario conectado, el <code>UserManager</code> se utiliza para buscar sus detalles y realizar una verificaci&#xF3;n de autorizaci&#xF3;n con <code>IsInRoleAsync()</code>. Si todas las comprobaciones son correctas y el usuario es un administrador, se agrega un enlace <strong>Administrar usuarios</strong> a la barra de navegaci&#xF3;n.</p>
<p>Para incluir este parcial en el dise&#xF1;o principal, edite <code>_Layout.cshtml</code> y agr&#xE9;guelo a la secci&#xF3;n de la barra de navegaci&#xF3;n:</p>
<p><strong>Views/Shared/_Layout.cshtml</strong></p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;navbar-collapse collapse&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;nav navbar-nav&quot;</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- existing code here --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    @await Html.PartialAsync(&quot;_LoginPartial&quot;)
    @await Html.PartialAsync(&quot;_AdminActionsPartial&quot;)
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>Cuando inicie sesi&#xF3;n con una cuenta de administrador, ahora ver&#xE1; un nuevo elemento en la parte superior derecha:</p>
<p><img src="manage-users.png" alt="Liga para administrar usuarios"></p>
                                </section>
    </div>
    <div class="search-results">
        <div class="has-results">
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
        </div>
        <div class="no-results">
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
        </div>
    </div>
</div>
                        </div>
                    </div>
            </div>
                <a href="using-identity-in-the-application.html" class="navigation navigation-prev " aria-label="Previous page: Usando identidad en la aplicación">
                    <i class="fa fa-angle-left"></i>
                </a>
                <a href="more-resources.html" class="navigation navigation-next " aria-label="Next page: Más recursos">
                    <i class="fa fa-angle-right"></i>
                </a>
    </div>
    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Autorización con roles","level":"1.7.3","depth":2,"next":{"title":"Más recursos","level":"1.7.4","depth":2,"path":"chapters/security-and-identity/more-resources.md","ref":"chapters/security-and-identity/more-resources.md","articles":[]},"previous":{"title":"Usando identidad en la aplicación","level":"1.7.2","depth":2,"path":"chapters/security-and-identity/using-identity-in-the-application.md","ref":"chapters/security-and-identity/using-identity-in-the-application.md","articles":[]},"dir":"ltr"},"config":{"plugins":["expandable-chapters-small","anchors","forkmegithub","analytics"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"analytics":{"google":"UA-130293099-1"},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"expandable-chapters-small":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"forkmegithub":{"color":"green","url":"https://github.com/jahbenjah/little-aspnetcore-book"},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"anchors":{}},"theme":"default","author":"Nate Barbettini","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Lato","paperSize":"a5","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"isbn":"978-1-387-75615-5","variables":{},"title":"El pequeño libro de ASP.NET Core","language":"es","gitbook":"*","description":"Una introducción amigable para construir aplicaciones web con el framework ASP.NET Core."},"file":{"path":"chapters/security-and-identity/authorization-with-roles.md","mtime":"2019-03-18T02:21:27.390Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-03-22T16:25:31.396Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>
    <script src="/assets/gitbook/gitbook.js"></script>
    <script src="/assets/gitbook/theme.js"></script>
        <script src="/assets/gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.js"></script>
        <script src="/assets/gitbook/gitbook-plugin-forkmegithub/plugin.js"></script>
        <script src="/assets/gitbook/gitbook-plugin-search/search-engine.js"></script>
        <script src="/assets/gitbook/gitbook-plugin-search/search.js"></script>
        <script src="/assets/gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        <script src="/assets/gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        <script src="/assets/gitbook/gitbook-plugin-sharing/buttons.js"></script>
        <script src="/assets/gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
    </body>
</html>